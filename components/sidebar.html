<!-- Sidebar Navigation -->
<aside id="sidebar" class="fixed left-0 top-0 h-full w-64 bg-[#0b1220]/95 backdrop-blur-xl border-r border-white/10 z-50 transform -translate-x-full transition-all duration-300 ease-in-out md:translate-x-0 overflow-y-auto sidebar-collapsible">
  <div class="flex flex-col h-full">
    <!-- Logo & Brand -->
    <div class="p-6 border-b border-white/10 relative">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3 sidebar-brand">
          <img src="./assets/img/logo-sitsense.svg" alt="SitSense" class="h-8 w-auto sidebar-logo" />
          <span class="text-xl font-bold tracking-tight sidebar-title">SitSense</span>
        </div>
        <!-- Toggle button (Desktop) -->
        <button class="hidden md:flex p-2 rounded-lg hover:bg-white/5 transition-colors cursor-pointer sidebar-toggle-btn" type="button" style="pointer-events: auto; z-index: 10;">
          <i data-lucide="panel-left-close" class="h-5 w-5 sidebar-toggle-icon"></i>
        </button>
        <!-- Close button (Mobile only) -->
        <button id="closeSidebar" class="md:hidden p-2 rounded-lg hover:bg-white/5 transition-colors">
          <i data-lucide="x" class="h-5 w-5"></i>
        </button>
      </div>
      <p class="text-xs text-slate-400 mt-1 sidebar-subtitle">Smart Posture Monitor</p>
    </div>

    <!-- Navigation Menu -->
    <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
      <a href="./home.html" data-nav="home" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 hover:bg-white/5 hover:text-cyan-300">
        <i data-lucide="home" class="h-5 w-5 flex-shrink-0"></i>
        <span class="font-medium sidebar-nav-text">Home</span>
      </a>
      <a href="./index.html" data-nav="dashboard" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 hover:bg-white/5 hover:text-cyan-300">
        <i data-lucide="layout-dashboard" class="h-5 w-5 flex-shrink-0"></i>
        <span class="font-medium sidebar-nav-text">Dashboard</span>
      </a>
      <a href="./history.html" data-nav="history" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 hover:bg-white/5 hover:text-cyan-300">
        <i data-lucide="history" class="h-5 w-5 flex-shrink-0"></i>
        <span class="font-medium sidebar-nav-text">Riwayat</span>
      </a>
      <a href="./reports.html" data-nav="reports" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 hover:bg-white/5 hover:text-cyan-300">
        <i data-lucide="file-text" class="h-5 w-5 flex-shrink-0"></i>
        <span class="font-medium sidebar-nav-text">Laporan</span>
      </a>
      <a href="./settings.html" data-nav="settings" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 hover:bg-white/5 hover:text-cyan-300">
        <i data-lucide="settings" class="h-5 w-5 flex-shrink-0"></i>
        <span class="font-medium sidebar-nav-text">Pengaturan</span>
      </a>
      <a href="./about.html" data-nav="about" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 hover:bg-white/5 hover:text-cyan-300">
        <i data-lucide="info" class="h-5 w-5 flex-shrink-0"></i>
        <span class="font-medium sidebar-nav-text">Tentang</span>
      </a>
      <a href="./help.html" data-nav="help" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 hover:bg-white/5 hover:text-cyan-300">
        <i data-lucide="help-circle" class="h-5 w-5 flex-shrink-0"></i>
        <span class="font-medium sidebar-nav-text">Bantuan</span>
      </a>
    </nav>

    <!-- Quick Actions -->
    <div class="p-4 border-t border-white/10 space-y-2">
      <button class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 hover:bg-white/5 hover:text-cyan-300">
        <i data-lucide="user" class="h-5 w-5 flex-shrink-0"></i>
        <span class="font-medium sidebar-nav-text">Profil</span>
      </button>
      <button id="themeToggleSidebar" onclick="window.SitSenseUI && SitSenseUI.toggleTheme()" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 hover:bg-white/5 hover:text-cyan-300">
        <i data-lucide="sun" class="h-5 w-5 flex-shrink-0"></i>
        <span class="font-medium sidebar-nav-text">Tema</span>
      </button>
      <button class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 hover:bg-white/5 hover:text-red-300 text-red-400">
        <i data-lucide="log-out" class="h-5 w-5 flex-shrink-0"></i>
        <span class="font-medium sidebar-nav-text">Keluar</span>
      </button>
    </div>
  </div>
</aside>

<!-- Sidebar Overlay (Mobile) -->
<div id="sidebarOverlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-40 opacity-0 pointer-events-none transition-opacity duration-300 md:hidden"></div>

<!-- Script untuk toggle sidebar -->
<script>
  (function() {
    // Sidebar management functions
    window.SidebarManager = {
      sidebar: null,
      overlay: null,
      hamburger: null,
      closeBtn: null,
      isCollapsed: false,
      
      init: function() {
        console.log('[Sidebar] Initializing sidebar manager...');
        this.sidebar = document.getElementById('sidebar');
        this.overlay = document.getElementById('sidebarOverlay');
        this.hamburger = document.getElementById('hamburgerMenu');
        this.closeBtn = document.getElementById('closeSidebar');
        
        if (!this.sidebar) {
          console.warn('[Sidebar] Sidebar element not found');
          return;
        }
        
        console.log('[Sidebar] Sidebar element found:', this.sidebar);
        
        // Load collapsed state from localStorage
        const savedState = localStorage.getItem('sidebar-collapsed');
        if (savedState === 'true') {
          this.collapse();
        }
        
        // Bind toggle button - retry mechanism untuk memastikan button sudah ada
        const bindToggleButton = () => {
          const toggleBtn = this.sidebar?.querySelector('.sidebar-toggle-btn');
          if (toggleBtn) {
            // Hapus listener lama jika ada
            if (toggleBtn.dataset.bound === 'true') {
              return true; // Already bound
            }
            
            toggleBtn.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              console.log('[Sidebar] Toggle button clicked');
              this.toggleCollapse();
            });
            
            // Juga bind dengan mousedown untuk memastikan event terdeteksi
            toggleBtn.addEventListener('mousedown', (e) => {
              e.preventDefault();
              e.stopPropagation();
            });
            
            toggleBtn.dataset.bound = 'true';
            toggleBtn.style.pointerEvents = 'auto';
            toggleBtn.style.cursor = 'pointer';
            console.log('[Sidebar] Toggle button bound successfully');
            return true;
          }
          console.warn('[Sidebar] Toggle button not found');
          return false;
        };
        
        // Try to bind immediately and retry if needed
        if (!bindToggleButton()) {
          setTimeout(() => {
            if (!bindToggleButton()) {
              setTimeout(() => {
                if (!bindToggleButton()) {
                  console.error('[Sidebar] Failed to bind toggle button after multiple retries');
                }
              }, 500);
            }
          }, 100);
        }
        
        // Juga gunakan event delegation sebagai fallback
        this.sidebar?.addEventListener('click', (e) => {
          if (e.target.closest('.sidebar-toggle-btn')) {
            e.preventDefault();
            e.stopPropagation();
            console.log('[Sidebar] Toggle button clicked via delegation');
            this.toggleCollapse();
          }
        });
        
        // Bind events - use event delegation for hamburger (might be in header)
        const bindHamburger = () => {
          const hamburger = document.getElementById('hamburgerMenu');
          if (hamburger && !hamburger.dataset.sidebarBound) {
            hamburger.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              this.toggle();
            });
            hamburger.dataset.sidebarBound = 'true';
          }
        };
        
        // Try to bind hamburger immediately and after a delay
        bindHamburger();
        setTimeout(bindHamburger, 100);
        setTimeout(bindHamburger, 500);
        
        if (this.closeBtn) {
          this.closeBtn.addEventListener('click', () => this.close());
        }
        
        if (this.overlay) {
          this.overlay.addEventListener('click', () => this.close());
        }
        
        // Close on escape key
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && this.isOpen()) {
            this.close();
          }
        });
        
        // Close sidebar when clicking nav links on mobile
        const navLinks = this.sidebar.querySelectorAll('a[data-nav]');
        navLinks.forEach(link => {
          link.addEventListener('click', () => {
            // Close sidebar on mobile after navigation
            if (window.innerWidth < 768) {
              setTimeout(() => this.close(), 100);
            }
          });
        });
        
        // Mark active nav item
        this.markActiveNav();
        
        // Update layout on init
        this.updateLayout();
        
        // Render icons
        if (window.lucide) {
          window.lucide.createIcons();
        }
        
        // Re-render icons after delay
        setTimeout(() => {
          if (window.lucide) {
            window.lucide.createIcons();
          }
        }, 200);
      },
      
      toggleCollapse: function() {
        console.log('[Sidebar] toggleCollapse called, current state:', this.isCollapsed);
        if (this.isCollapsed) {
          this.expand();
        } else {
          this.collapse();
        }
      },
      
      collapse: function() {
        if (!this.sidebar) return;
        this.isCollapsed = true;
        this.sidebar.classList.add('collapsed');
        localStorage.setItem('sidebar-collapsed', 'true');
        this.updateLayout();
        this.updateToggleIcon();
      },
      
      expand: function() {
        if (!this.sidebar) return;
        this.isCollapsed = false;
        this.sidebar.classList.remove('collapsed');
        localStorage.setItem('sidebar-collapsed', 'false');
        this.updateLayout();
        this.updateToggleIcon();
      },
      
      updateLayout: function() {
        // Only update layout on desktop (md and above)
        if (window.innerWidth < 768) {
          return;
        }
        
        const header = document.querySelector('header');
        const main = document.querySelector('main');
        const isCollapsed = this.isCollapsed;
        
        if (header) {
          if (isCollapsed) {
            header.classList.add('sidebar-collapsed');
            header.style.setProperty('margin-left', '80px', 'important');
          } else {
            header.classList.remove('sidebar-collapsed');
            header.style.setProperty('margin-left', '256px', 'important');
          }
        }
        
        if (main) {
          if (isCollapsed) {
            main.classList.add('sidebar-collapsed');
            main.style.setProperty('margin-left', '80px', 'important');
          } else {
            main.classList.remove('sidebar-collapsed');
            main.style.setProperty('margin-left', '256px', 'important');
          }
        }
      },
      
      updateToggleIcon: function() {
        const icon = this.sidebar?.querySelector('.sidebar-toggle-icon');
        if (icon) {
          if (this.isCollapsed) {
            icon.setAttribute('data-lucide', 'panel-left-open');
          } else {
            icon.setAttribute('data-lucide', 'panel-left-close');
          }
          if (window.lucide) {
            window.lucide.createIcons();
          }
        }
      },
      
      open: function() {
        if (!this.sidebar) return;
        // Di desktop (md dan lebih besar), sidebar selalu terlihat, tidak perlu open
        if (window.innerWidth >= 768) {
          return; // Desktop: sidebar selalu visible
        }
        // Mobile: buka sidebar
        this.sidebar.classList.remove('-translate-x-full');
        if (this.overlay) {
          this.overlay.classList.remove('opacity-0', 'pointer-events-none');
          this.overlay.classList.add('opacity-100', 'pointer-events-auto');
        }
        document.body.style.overflow = 'hidden';
      },
      
      close: function() {
        if (!this.sidebar) return;
        // Di desktop (md dan lebih besar), sidebar selalu terlihat, tidak perlu close
        if (window.innerWidth >= 768) {
          return; // Desktop: sidebar selalu visible
        }
        // Mobile: tutup sidebar
        this.sidebar.classList.add('-translate-x-full');
        if (this.overlay) {
          this.overlay.classList.remove('opacity-100', 'pointer-events-auto');
          this.overlay.classList.add('opacity-0', 'pointer-events-none');
        }
        document.body.style.overflow = '';
      },
      
      toggle: function() {
        // Di desktop, sidebar selalu terlihat, tidak perlu toggle
        if (window.innerWidth >= 768) {
          return; // Desktop: sidebar selalu visible
        }
        // Mobile: toggle sidebar
        if (this.isOpen()) {
          this.close();
        } else {
          this.open();
        }
      },
      
      isOpen: function() {
        if (!this.sidebar) return false;
        return !this.sidebar.classList.contains('-translate-x-full');
      },
      
      markActiveNav: function() {
        const path = location.pathname.toLowerCase();
        const file = path.split('/').pop() || 'index.html';
        
        document.querySelectorAll('a[data-nav]').forEach(a => {
          // Remove previous active state
          a.classList.remove('bg-cyan-500/10', 'text-cyan-300', 'border-l-2', 'border-cyan-400', 'active');
          
          const k = a.getAttribute('data-nav');
          const isActive = 
            (k === 'home' && (file === 'home.html' || path.includes('home'))) ||
            (k === 'dashboard' && (file === 'index.html' || file === '' || path.endsWith('/'))) ||
            (k === 'history' && (file === 'history.html' || path.includes('history'))) ||
            (k === 'reports' && (file === 'reports.html' || path.includes('reports'))) ||
            (k === 'settings' && (file === 'settings.html' || path.includes('settings'))) ||
            (k === 'about' && (file === 'about.html' || path.includes('about'))) ||
            (k === 'help' && (file === 'help.html' || path.includes('help')));
          
          if (isActive) {
            a.classList.add('bg-cyan-500/10', 'text-cyan-300', 'border-l-2', 'border-cyan-400', 'active');
          }
        });
      }
    };
    
    // Initialize when DOM is ready - dengan retry mechanism
    function initializeSidebar() {
      // Pastikan sidebar sudah ada di DOM
      const sidebar = document.getElementById('sidebar');
      if (!sidebar) {
        console.log('[Sidebar] Sidebar not found, retrying...');
        setTimeout(initializeSidebar, 100);
        return;
      }
      
      // Initialize sidebar manager
      if (window.SidebarManager && typeof window.SidebarManager.init === 'function') {
        window.SidebarManager.init();
      }
      
      // Handle window resize - ensure sidebar state is correct
      let resizeTimer;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
          // Di desktop, pastikan sidebar selalu terlihat
          if (window.innerWidth >= 768) {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
              sidebar.classList.remove('-translate-x-full');
              const overlay = document.getElementById('sidebarOverlay');
              if (overlay) {
                overlay.classList.add('opacity-0', 'pointer-events-none');
                overlay.classList.remove('opacity-100', 'pointer-events-auto');
              }
              document.body.style.overflow = '';
            }
          }
          // Update layout on resize
          if (window.SidebarManager) {
            window.SidebarManager.updateLayout();
          }
        }, 250);
      });
    }
    
    // Try to initialize immediately, or wait for DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeSidebar);
    } else {
      // Give a small delay to ensure sidebar HTML is injected
      setTimeout(initializeSidebar, 50);
    }
    
    // Re-render icons after a delay to ensure lucide is loaded
    setTimeout(() => {
      if (window.lucide) {
        window.lucide.createIcons();
      }
    }, 100);
  })();
</script>

